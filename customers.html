<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة العملاء والديون | أولاد الخواص</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="libs/fontawesome.min.css">
</head>
<body>
    <div class="nav-overlay" onclick="DB.toggleMenu()"></div>
    <nav>
        <div class="logo"><i class="fas fa-faucet-drip"></i> أولاد الخواص</div>
        <div class="nav-toggle" onclick="DB.toggleMenu()"><i class="fas fa-bars"></i></div>
        <div class="nav-links">
            <button class="nav-close" onclick="DB.toggleMenu()"><i class="fas fa-times"></i></button>
            <a href="dashboard.html"><i class="fas fa-chart-pie"></i> الرئيسة</a>
            <a href="index.html"><i class="fas fa-cash-register"></i> المبيعات</a>
            <a href="products.html"><i class="fas fa-boxes-stacked"></i> الأصناف</a>
            <a href="purchases.html"><i class="fas fa-cart-shopping"></i> المشتريات</a>
            <a href="expenses.html"><i class="fas fa-money-bill-wave"></i> المصروفات</a>
            <a href="suppliers.html"><i class="fas fa-truck-field"></i> الموردين</a>
            <a href="customers.html" class="active"><i class="fas fa-users-gear"></i> العملاء</a>
            <a href="reports.html"><i class="fas fa-chart-line"></i> التقارير</a>
            <a href="profit-loss.html"><i class="fas fa-balance-scale"></i> الأرباح</a>
        </div>
    </nav>

    <div class="container">
        <div class="card animate-fade">
            <div class="card-title"><i class="fas fa-user-plus"></i> إضافة / تعديل عميل</div>
            <form id="customerForm">
                <input type="hidden" id="custId">
                <div class="grid-3" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div class="input-group">
                        <label>اسم العميل</label>
                        <input type="text" id="cName" required>
                    </div>
                    <div class="input-group">
                        <label>رقم الهاتف</label>
                        <input type="text" id="cPhone">
                    </div>
                    <div class="input-group">
                        <label>الرصيد/الدين (ج.م)</label>
                        <input type="number" id="cBalance" step="0.01" value="0">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">حفظ العميل</button>
            </form>
        </div>

        <!-- ملخص الديون -->
        <div class="grid-3" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
            <div class="card animate-fade" style="margin-bottom: 0; padding: 1.5rem; animation-delay: 0.1s;">
                <small style="color: var(--text-gray);">إجمالي الديون</small>
                <div style="font-size: 1.8rem; font-weight: 800; color: var(--danger); margin-top: 0.5rem;" id="totalDebts">0.00</div>
                <small style="opacity: 0.7;">ج.م</small>
            </div>
            <div class="card animate-fade" style="margin-bottom: 0; padding: 1.5rem; animation-delay: 0.2s;">
                <small style="color: var(--text-gray);">عدد العملاء المدينين</small>
                <div style="font-size: 1.8rem; font-weight: 800; color: var(--warning); margin-top: 0.5rem;" id="debtorsCount">0</div>
                <small style="opacity: 0.7;">عميل</small>
            </div>
            <div class="card animate-fade" style="margin-bottom: 0; padding: 1.5rem; animation-delay: 0.3s;">
                <small style="color: var(--text-gray);">إجمالي العملاء</small>
                <div style="font-size: 1.8rem; font-weight: 800; color: var(--primary-color); margin-top: 0.5rem;" id="totalCustomers">0</div>
                <small style="opacity: 0.7;">عميل</small>
            </div>
        </div>

        <div class="card animate-fade" style="animation-delay: 0.4s">
            <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                <span><i class="fas fa-users"></i> قائمة العملاء والمديونيات</span>
                <button class="btn btn-primary" onclick="exportCustomersReport()" style="padding: 5px 15px; font-size: 0.9rem;">
                    <i class="fas fa-file-export"></i> تصدير تقرير
                </button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>الاسم</th>
                            <th>الهاتف</th>
                            <th>المبلغ المطلوب (دين)</th>
                            <th>إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="customerTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="libs/xlsx.full.min.js"></script>    <script src="js/initial_data.js"></script>
    <script src="js/company-info.js"></script>
    <script src="js/data.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            DB.checkAuth();
            const form = document.getElementById('customerForm');
            const tbody = document.getElementById('customerTableBody');
            let customers = await DB.getCustomers();

            function render() {
                tbody.innerHTML = '';
                
                // Update summary stats
                const totalDebtsAmount = customers.reduce((sum, c) => sum + (c.balance > 0 ? c.balance : 0), 0);
                const debtorsCountNum = customers.filter(c => c.balance > 0).length;
                
                document.getElementById('totalDebts').textContent = totalDebtsAmount.toFixed(2);
                document.getElementById('debtorsCount').textContent = debtorsCountNum;
                document.getElementById('totalCustomers').textContent = customers.length;
                
                customers.forEach(c => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${c.name}</td>
                        <td>${c.phone || '--'}</td>
                        <td style="color: ${c.balance > 0 ? 'var(--danger)' : 'var(--success)'}; font-weight: bold;">${(c.balance || 0).toFixed(2)}</td>
                        <td>
                            <button class="btn btn-primary" onclick="editCust(${c.id})" style="padding: 5px 10px;"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-success" onclick="payDebt(${c.id})" title="تسديد مبلغ" style="padding: 5px 10px;"><i class="fas fa-hand-holding-dollar"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            form.onsubmit = async (e) => {
                e.preventDefault();
                const id = document.getElementById('custId').value ? parseInt(document.getElementById('custId').value) : null;
                const customer = {
                    id,
                    name: document.getElementById('cName').value,
                    phone: document.getElementById('cPhone').value,
                    balance: parseFloat(document.getElementById('cBalance').value)
                };

                await DB.saveCustomer(customer);
                DB.showToast('تم الحفظ');
                form.reset();
                document.getElementById('custId').value = '';
                customers = await DB.getCustomers();
                render();
            };

            window.editCust = (id) => {
                const c = customers.find(c => c.id === id);
                if (c) {
                    document.getElementById('custId').value = c.id;
                    document.getElementById('cName').value = c.name;
                    document.getElementById('cPhone').value = c.phone || '';
                    document.getElementById('cBalance').value = c.balance || 0;
                }
            };

            window.payDebt = async (id) => {
                const c = customers.find(c => c.id === id);
                if (c) {
                    const val = await DB.prompt(`الرصيد الحالي: ${c.balance}\nأدخل المبلغ الذي سددّه العميل:`, 'تسديد ديون');
                    const amount = parseFloat(val);
                    if (!isNaN(amount)) {
                        c.balance -= amount;
                        await DB.saveCustomer(c);
                        customers = await DB.getCustomers();
                        render();
                        DB.showToast('تم تحديث الرصيد بنجاح');
                    }
                }
            };

            window.exportCustomersReport = () => {
                const data = [
                    ['تقرير ديون العملاء - أولاد الخواص'],
                    ['التاريخ:', new Date().toLocaleDateString('ar-EG')],
                    [],
                    ['اسم العميل', 'رقم الهاتف', 'المبلغ المطلوب (ج.م)']
                ];

                customers.filter(c => c.balance > 0).forEach(c => {
                    data.push([c.name, c.phone || '--', c.balance.toFixed(2)]);
                });

                data.push([]);
                data.push(['إجمالي الديون', '', customers.reduce((sum, c) => sum + (c.balance > 0 ? c.balance : 0), 0).toFixed(2)]);

                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'ديون العملاء');
                XLSX.writeFile(wb, `تقرير_ديون_العملاء_${new Date().toLocaleDateString('ar-EG')}.xlsx`);
                DB.showToast('تم تصدير التقرير بنجاح');
            };

            render();
        });
    </script>
</body>
</html>
