<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>طباعة باركود | أولاد الخواص</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="libs/fontawesome.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
</head>
<body>
    <div class="nav-overlay" onclick="DB.toggleMenu()"></div>
    <nav>
        <div class="logo"><i class="fas fa-faucet-drip"></i> أولاد الخواص</div>
        <div class="nav-toggle" onclick="DB.toggleMenu()"><i class="fas fa-bars"></i></div>
        <div class="nav-links">
            <button class="nav-close" onclick="DB.toggleMenu()"><i class="fas fa-times"></i></button>
            <a href="dashboard.html"><i class="fas fa-chart-pie"></i> الرئيسة</a>
            <a href="index.html"><i class="fas fa-cash-register"></i> المبيعات</a>
            <a href="products.html"><i class="fas fa-boxes-stacked"></i> الأصناف</a>
            <a href="purchases.html"><i class="fas fa-cart-shopping"></i> المشتريات</a>
            <a href="print-barcode.html" class="active"><i class="fas fa-barcode"></i> طباعة باركود</a>
        </div>
    </nav>

    <div class="container">
        <div class="card animate-fade">
            <div class="card-title"><i class="fas fa-barcode"></i> طباعة باركود الأصناف</div>
            
            <div class="grid-3" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <div class="input-group">
                    <label>اختر الصنف</label>
                    <select id="productSelect" style="padding: 10px;">
                        <option value="">اختر صنف...</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>عدد النسخ</label>
                    <input type="number" id="copies" value="1" min="1" max="100" style="padding: 10px;">
                </div>
                <div style="display: flex; align-items: flex-end;">
                    <button class="btn btn-primary" onclick="generateBarcode()" style="width: 100%;">
                        <i class="fas fa-plus"></i> إضافة للطباعة
                    </button>
                </div>
            </div>

            <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid rgba(255,255,255,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="margin: 0; color: var(--primary-color);">
                        <i class="fas fa-print"></i> معاينة الطباعة
                    </h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-success" onclick="printBarcodes()" style="padding: 8px 20px;">
                            <i class="fas fa-print"></i> طباعة
                        </button>
                        <button class="btn btn-danger" onclick="clearAll()" style="padding: 8px 20px;">
                            <i class="fas fa-trash"></i> مسح الكل
                        </button>
                    </div>
                </div>
                
                <div id="barcodeContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 8px; min-height: 200px;">
                    <p style="text-align: center; opacity: 0.5; grid-column: 1/-1;">اختر صنف لإضافة باركود...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Print Styles -->
    <style>
        @media print {
            body * {
                visibility: hidden;
            }
            
            #barcodeContainer, #barcodeContainer * {
                visibility: visible;
            }
            
            #barcodeContainer {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                display: grid !important;
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 10mm !important;
                padding: 10mm !important;
                background: white !important;
            }
            
            .barcode-item {
                page-break-inside: avoid;
                border: 1px dashed #000 !important;
                padding: 5mm !important;
                background: white !important;
            }
            
            .barcode-item h4 {
                color: #000 !important;
            }
            
            .barcode-item p {
                color: #000 !important;
            }
            
            nav, .card-title, .grid-3, button, .btn {
                display: none !important;
            }
        }
        
        .barcode-item {
            background: rgba(255,255,255,0.05);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            border: 2px dashed rgba(255,255,255,0.1);
            position: relative;
        }
        
        .barcode-item h4 {
            margin: 0 0 0.5rem 0;
            color: var(--primary-color);
            font-size: 0.95rem;
        }
        
        .barcode-item svg {
            background: white;
            padding: 5px;
            border-radius: 4px;
            margin: 0.5rem 0;
        }
        
        .barcode-item p {
            margin: 0.3rem 0;
            font-size: 0.85rem;
            opacity: 0.9;
        }
        
        .barcode-item .remove-btn {
            position: absolute;
            top: 5px;
            left: 5px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }
        
        .barcode-item .remove-btn:hover {
            background: #dc2626;
        }
    </style>

    <script src="js/initial_data.js"></script>
    <script src="js/company-info.js"></script>
    <script src="js/data.js"></script>
    <script>
        let products = [];
        let barcodeCount = 0;

        document.addEventListener('DOMContentLoaded', async () => {
            DB.checkAuth();
            products = await DB.getProducts();
            
            const select = document.getElementById('productSelect');
            products.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = `${p.name} - ${p.barcode || 'بدون باركود'}`;
                option.dataset.product = JSON.stringify(p);
                select.appendChild(option);
            });
        });

        function generateBarcode() {
            const select = document.getElementById('productSelect');
            const selectedOption = select.options[select.selectedIndex];
            
            if (!selectedOption.value) {
                DB.showToast('يرجى اختيار صنف', 'error');
                return;
            }

            const product = JSON.parse(selectedOption.dataset.product);
            const copies = parseInt(document.getElementById('copies').value) || 1;

            if (!product.barcode) {
                DB.showToast('هذا الصنف ليس له باركود', 'error');
                return;
            }

            const container = document.getElementById('barcodeContainer');
            
            // إزالة رسالة "اختر صنف" إذا كانت موجودة
            if (container.querySelector('p')) {
                container.innerHTML = '';
            }

            for (let i = 0; i < copies; i++) {
                barcodeCount++;
                const div = document.createElement('div');
                div.className = 'barcode-item';
                div.id = `barcode-${barcodeCount}`;
                div.innerHTML = `
                    <button class="remove-btn" onclick="removeBarcode('barcode-${barcodeCount}')">
                        <i class="fas fa-times"></i>
                    </button>
                    <h4>${product.name}</h4>
                    <svg id="svg-${barcodeCount}"></svg>
                    <p><strong>السعر:</strong> ${product.price.toFixed(2)} ج.م</p>
                    <p><strong>الباركود:</strong> ${product.barcode}</p>
                `;
                container.appendChild(div);

                // Generate barcode using JsBarcode
                try {
                    JsBarcode(`#svg-${barcodeCount}`, product.barcode, {
                        format: "CODE128",
                        width: 2,
                        height: 50,
                        displayValue: true,
                        fontSize: 14,
                        margin: 5
                    });
                } catch (e) {
                    console.error('Barcode generation error:', e);
                    div.querySelector('svg').innerHTML = '<text>باركود غير صالح</text>';
                }
            }

            DB.showToast(`تم إضافة ${copies} باركود`);
        }

        function removeBarcode(id) {
            const element = document.getElementById(id);
            if (element) {
                element.remove();
                DB.showToast('تم إزالة الباركود');
            }
            
            const container = document.getElementById('barcodeContainer');
            if (container.children.length === 0) {
                container.innerHTML = '<p style="text-align: center; opacity: 0.5; grid-column: 1/-1;">اختر صنف لإضافة باركود...</p>';
            }
        }

        function clearAll() {
            const container = document.getElementById('barcodeContainer');
            container.innerHTML = '<p style="text-align: center; opacity: 0.5; grid-column: 1/-1;">اختر صنف لإضافة باركود...</p>';
            barcodeCount = 0;
            DB.showToast('تم مسح جميع الباركودات');
        }

        function printBarcodes() {
            const container = document.getElementById('barcodeContainer');
            if (container.children.length === 0 || container.querySelector('p')) {
                DB.showToast('لا توجد باركودات للطباعة', 'error');
                return;
            }
            
            window.print();
        }
    </script>
</body>
</html>
